
<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>高标连线（Highbar）</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif; margin: 0; padding: 16px; }
    #app { max-width: 1000px; margin: 0 auto; }
    #chart { height: 480px; border: 1px solid #eee; border-radius: 8px; }
    #stocks { margin-top: 16px; padding: 12px; border: 1px solid #eee; border-radius: 8px; }
    .row { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #f0f0f0; }
    .row:last-child { border-bottom: none; }
    .left { color: #333; font-size: 14px; }
    .right { display: flex; gap: 8px; }
    button { cursor: pointer; padding: 6px 10px; border: 1px solid #ddd; border-radius: 6px; background: #fff; }
    button:hover { background: #f5f5f5; }
    .modal-close { background: #fffbeb; border-color: #facc15; }
  </style>

  <!-- 本地优先加载 ECharts，避免浏览器 Tracking Prevention 影响 -->
  ./echarts.min.js</script>
  <!-- 可选：CDN 作为附加覆盖（不是必须） -->
  <script>
    (function loadCdnEcharts(){
      var s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js';
      s.async = true;
      s.onload = function(){ console.log('CDN echarts loaded (optional overwrite).'); };
      s.onerror = function(){ console.warn('CDN echarts failed, using local copy.'); };
      document.head.appendChild(s);
    })();
  </script>
</head>
<body>
  <div id="app">
    <h1 style="margin: 0 0 12px;">高标连线（Highbar）</h1>
    <div id="chart"></div>
    <div id="stocks"></div>
    <!-- 可选：如果你使用模态层，这里提供一个占位符以便关闭按钮能正常工作 -->
    <div id="stockModalBackdrop" style="display:none"></div>
  </div>

  <script>
    // ------- 工具函数 -------
    function sleep(ms){ return new Promise(resolve => setTimeout(resolve, ms)); }
    // 简单的 A 股交易时间判断（本地时间，09:30-11:30，13:00-15:00）
    function isTradingNow(){
      var now = new Date();
      var h = now.getHours();
      var m = now.getMinutes();
      var t = h * 60 + m;
      return (t >= 9*60 + 30 && t <= 11*60 + 30) || (t >= 13*60 && t <= 15*60);
    }

    // ------- 图表刷新（示例，可替换为你的真实逻辑） -------
    function refreshChart(){
      var el = document.getElementById('chart');
      if (!window.echarts){
        console.error('ECharts not available.');
        return;
      }
      var chart = echarts.getInstanceByDom(el) || echarts.init(el);
      var option = {
        title: { text: '高标连线（示例）' },
        tooltip: {},
        xAxis: { type: 'category', data: ['一','二','三','四','五','六','七'] },
        yAxis: { type: 'value' },
        series: [{ type: 'line', data: [1,3,2,5,4,6,5] }]
      };
      chart.setOption(option);
    }

    // ------- 构建个股行与“打开”按钮（修复了 411–426 段的语法问题） -------
    function createStockRow(st){
      // st: { code: '000001', mc: '平安银行' }
      var row = document.createElement('div');
      row.className = 'row';

      var left = document.createElement('div');
      left.className = 'left';
      left.textContent = (st.mc || st.name || '') + '  ' + (st.code || '');

      var right = document.createElement('div');
      right.className = 'right';

      var open = document.createElement('button');
      open.textContent = '查看';
      open.className = 'open-btn';

      open.onclick = function(){
        var code = st.code || '';
        var name = st.mc || st.name || '';
        var url;
        if (/^\d{6}$/.test(code)){
          // 修正为模板字符串，eastmoney 行情页
          url = `http://quote.eastmoney.com/${code}.html`;
        }else{
          // 修正为 baidu 域名、逻辑或与 encodeURIComponent
          url = `https://www.baidu.com/s?wd=${encodeURIComponent(code || name || '')}`;
        }
        window.open(url, '_blank');
      };

      right.appendChild(open);
      row.appendChild(left);
      row.appendChild(right);
      return row;
    }

    // ------- 示例的个股卡片刷新（含关闭按钮） -------
    function refreshStocks(){
      var card = document.getElementById('stocks');
      card.innerHTML = '';

      // 示例列表：替换为你的真实数据源
      var demoList = [
        { code: '000001', mc: '平安银行' },
        { code: '600519', mc: '贵州茅台' },
        { code: '', mc: '示例（无代码）' }
      ];

      demoList.forEach(function(st){
        var row = createStockRow(st);
        card.appendChild(row);
      });

      // 关闭区域（对应你截图中的关闭按钮逻辑）
      var closeWrap = document.createElement('div');
      closeWrap.style.marginTop = '10px';
      closeWrap.style.textAlign = 'right';

      var btnClose = document.createElement('button');
      btnClose.className = 'modal-close';
      btnClose.textContent = '关闭';

      btnClose.onclick = function(){
        var b = document.getElementById('stockModalBackdrop');
        if (b) b.remove();
      };

      closeWrap.appendChild(btnClose);
      card.appendChild(closeWrap);
      // ⚠️ 注意：这里不再有多余的 "});"，避免语法错误
    }

    // ------- 主刷新与自动轮询 -------
    async function refreshAll(){
      refreshChart();
      refreshStocks();
    }

    // 仅在交易时段循环刷新
    async function autoLoop(){
      while(true){
        if (isTradingNow()){ await refreshAll(); }
        await sleep(5*60*1000); // 每 5 分钟
      }
    }

    // 首次渲染 + 自动轮询
    refreshAll();
    autoLoop();
  </script>
  
<script>
  async function loadTodayData() {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2, '0');
    const dd = String(d.getDate()).padStart(2, '0');
    const url = `./data/${yyyy}-${mm}-${dd}.json`;
    try {
      const r = await fetch(url, { cache: 'no-store' });
      if (!r.ok) throw new Error(r.status);
      return await r.json();
    } catch {
      const d2 = new Date(d.getTime() - 24*60*60*1000);
      const yyyy2 = d2.getFullYear();
      const mm2 = String(d2.getMonth()+1).padStart(2, '0');
      const dd2 = String(d2.getDate()).padStart(2, '0');
      const url2 = `./data/${yyyy2}-${mm2}-${dd2}.json`;
      const r2 = await fetch(url2).catch(() => null);
      return r2 && r2.ok ? r2.json() : { date: `${yyyy}-${mm}-${dd}`, pool: [], summary: { count: 0, highest: 0 } };
    }
  }

  async function refreshChartFromFile() {
    const data = await loadTodayData();
    if (!window.echarts) { console.error('ECharts not loaded'); return; }
    const el = document.getElementById('chart');
    const chart = echarts.getInstanceByDom(el) || echarts.init(el);

    const titleText = `高标连线：${data.summary?.highest ?? 0} 连`;
    const option = {
      title: { text: titleText },
      tooltip: {},
      xAxis: { type: 'category', data: data.pool.map(x => x.name || x.code) },
      yAxis: { type: 'value' },
      series: [{ type: 'bar', data: data.pool.map(x => x.boards || 0) }]
    };
    chart.setOption(option);
  }

  async function refreshAll(){
    await refreshChartFromFile();
    // 如需卡片列表：使用 data.pool
    // const card = document.getElementById('stocks');
    // card.innerHTML = '';
    // data.pool.forEach(st => card.appendChild(createStockRow({ code: st.code, mc: st.name })));
  }
</script>

</body>
</html>
