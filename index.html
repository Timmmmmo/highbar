
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>A股高标连线（最高连板）可视化</title>
  <meta name="description" content="基于必盈涨停股池的历史最高连板曲线可视化" />
  <!-- 优先 CDN，失败回退到本地 -->
  <script defer src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"
         font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans CJK SC', sans-serif; margin: 0; padding: 16px;}
    header, footer {margin-bottom: 16px;}
    #chart { width: 100%; height: 520px; background: #fafafa; border: 1px solid #eee; }
    .controls { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; align-items: center; }
    .controls input { flex: 1 1 320px; padding: 8px; }
    .controls button { padding: 8px 12px; }
    .msg { margin-top: 8px; color: #c33; }
  </style>
</head>
<body>
  <header>
    <h1>高标连线（最高连板）</h1>
    <p>默认优先使用同源数据 <code>./data/YYYY-MM-DD.json</code>；无数据时再走代理/API。</p>
  </header>

  <section class="controls">
    <input id="proxyUrl" type="url" placeholder="代理/数据 URL（可填 Cloudflare Worker 或直接数据 JSON 路径）" />
    <button id="loadBtn">加载数据并绘图</button>
    <button id="resetBtn">重置</button>
  </section>

  <div id="chart" role="img" aria-label="最高连板走势图表"></div>
  <div class="msg" id="msg"></div>

  <footer>
    <small>© 2025 高标连线 • 本页面为静态展示，数据来源请按你的授权使用。</small>
  </footer>

  <script defer>
    const $ = sel => document.querySelector(sel);
    const todayStr = new Date().toISOString().slice(0,10);

    async function fetchJson(url, opts) {
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(), 12_000); // 12s 超时
      try {
        const res = await fetch(url, {mode: 'cors', cache:'no-store', signal: ctrl.signal, ...opts}); // 详见 MDN Fetch 行为
        // 仅网络错误或被拦截才会 reject；4xx/5xx 仍 resolve（需检查 res.ok）[5](https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API/Using_Fetch)
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } finally { clearTimeout(t); }
    }

    function showMsg(text, isErr=true){ const el=$('#msg'); el.textContent = text ?? ''; el.style.color = isErr ? '#c33' : '#0a0'; }

    function draw(data) {
      // 数据格式假定：[{date:'YYYY-MM-DD', maxBoards: N}, ...]
      const dom = $('#chart');
      const chart = echarts.init(dom);
      const dates = data.map(d=>d.date);
      const values = data.map(d=>d.maxBoards);

      chart.setOption({
        title: {text: '历史最高连板'},
        tooltip: {trigger: 'axis'},
        xAxis: {type:'category', data: dates},
        yAxis: {type:'value', min:0, name:'连板数'},
        series: [{type:'line', name:'最高连板', data: values, smooth:true}],
        grid: {left: 40, right: 24, top: 48, bottom: 36}
      });
      window.addEventListener('resize', ()=>chart.resize());
    }

    async function loadData() {
      showMsg('');
      const localUrl = `./data/${todayStr}.json`;
      const proxyUrl = $('#proxyUrl').value.trim();

      // 1) 优先同源静态 JSON（无 CORS）
      try {
        const local = await fetchJson(localUrl, {mode:'same-origin'}); // 同源直接读，避免跨域
        draw(local);
        showMsg(`已加载同源数据：${localUrl}`, false);
        return;
      } catch (e) {
        // 同源无数据或404则继续尝试代理
      }

      // 2) 再尝试用户输入的代理/数据 URL
      if (proxyUrl) {
        try {
          const remote = await fetchJson(proxyUrl);
          draw(remote);
          showMsg(`已通过代理/数据URL加载：${proxyUrl}`, false);
          return;
        } catch (e) {
          showMsg(`加载失败：${e.message}`);
        }
      } else {
        showMsg('未找到同源数据；请提供代理/数据 URL');
      }
    }

    $('#loadBtn').addEventListener('click', loadData);
    $('#resetBtn').addEventListener('click', ()=>{ $('#proxyUrl').value=''; showMsg('已重置'); });
    document.addEventListener('DOMContentLoaded', ()=>{ /* 可选：自动尝试加载 */ });
  </script>
</body>
</html>
